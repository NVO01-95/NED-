{% extends "base.html" %}

{% block title %}Admin · NED{% endblock %}

{% block content %}
<section class="ned-card">
    <h2>Admin control panel</h2>
    <p class="small-hint">
        This area is only visible to admin accounts. You can manage users, reset passwords
        and moderate voyage notes. Data is stored locally in <code>ned_data.json</code>.
    </p>

    {% if admin_message %}
        <p style="color: #0c6b2c; font-size: 0.9rem; margin-top: 8px;">
            {{ admin_message }}
        </p>
    {% endif %}
    {% if admin_error %}
        <p style="color: #b00020; font-size: 0.9rem; margin-top: 8px;">
            {{ admin_error }}
        </p>
    {% endif %}
</section>

<section class="ned-card">
    <h3>Admin tools</h3>
    <p class="small-hint">
        Quick links to admin-only utilities.
    </p>

    <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
        <a class="nav-link" href="{{ url_for('admin_locations') }}">Manage Locations</a>
       
        
        
    </div>

    <p class="small-hint" style="margin-top: 8px;">
        Locations are used when users type place names in Route Planner waypoints (instead of coordinates).
    </p>
</section>

<section class="ned-card">
    <h3>Global data overview</h3>
    <ul>
        <li><strong>Users:</strong> {{ summary.users }}</li>
        <li><strong>Voyages:</strong> {{ summary.voyages }}</li>
        <li><strong>Routes:</strong> {{ summary.routes }}</li>
        <li><strong>Logbook entries:</strong> {{ summary.log_entries }}</li>
        <li><strong>Official contacts:</strong> {{ summary.contacts }}</li>
        <li><strong>Personal contacts:</strong> {{ summary.personal_contacts }}</li>
        <li><strong>Weather notes:</strong> {{ summary.weather_notes }}</li>
    </ul>

    <p class="small-hint" style="margin-top: 8px;">
        For JSON export/import and full reset, use the <a href="{{ url_for('settings') }}">Settings</a> page.
    </p>
</section>

<section class="ned-card">
    <h3>Reset user password</h3>
    <form method="post" action="{{ url_for('admin_reset_password') }}" class="voyage-form">
        <div class="form-row">
            <label for="user_id">User</label>
            <select id="user_id" name="user_id" required>
                <option value="">-- choose user --</option>
                {% for u in users %}
                    <option value="{{ u.id }}">
                        #{{ u.id }} · {{ u.username }}{% if u.is_admin %} (admin){% endif %}
                    </option>
                {% endfor %}
            </select>
        </div>

        <div class="form-row">
            <label for="new_password">New password</label>
            <input
                id="new_password"
                name="new_password"
                type="password"
                placeholder="At least 4 characters"
                required
            >
        </div>

        <button type="submit" class="btn btn-small">Set new password</button>
    </form>
</section>

<section class="ned-card">
    <h3>Users</h3>
    {% if users %}
        <table class="voyage-table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Username</th>
                    <th>Admin</th>
                    <th>Can post</th>
                </tr>
            </thead>
            <tbody>
                {% for u in users %}
                <tr>
                    <td>{{ u.id }}</td>
                    <td>{{ u.username }}</td>
                    <td>{{ 'Yes' if u.is_admin else 'No' }}</td>
                    <td>{{ 'Yes' if u.can_post else 'No' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <p class="small-hint">
            We can later add buttons here for blocking posting, deleting users, or promoting to admin.
        </p>
    {% else %}
        <p>No users found.</p>
    {% endif %}
</section>

<section class="ned-card">
    <h3>Voyage notes moderation</h3>
    {% if voyages %}
        <table class="voyage-table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Route</th>
                    <th>Notes (preview)</th>
                </tr>
            </thead>
            <tbody>
                {% for v in voyages %}
                <tr>
                    <td>{{ loop.index0 }}</td>
                    <td>{{ v.departure }} &rarr; {{ v.destination }}</td>
                    <td>
                        {% if v.notes %}
                            {{ v.notes[:80] }}{% if v.notes|length > 80 %}...{% endif %}
                        {% else %}
                            <span class="small-hint">No notes.</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <p class="small-hint">
            We already have the logic to clear notes or delete voyages; we can add buttons here later.
        </p>
    {% else %}
        <p>No voyages stored yet.</p>
    {% endif %}
</section>
{% endblock %}

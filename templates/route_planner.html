{% extends "base.html" %}
{% block title %}Route Planner · NED{% endblock %}

{% block content %}
<section class="ned-card">
  <h2>Route Planner</h2>
  <p class="small-hint">Enter waypoints as coordinates. NED will calculate distance, bearing and ETA.</p>

  {% if calc_error %}
    <p style="color:#b00020; font-size:0.9rem;">{{ calc_error }}</p>
  {% endif %}

  <form method="post" action="{{ url_for('route_planner') }}" class="voyage-form">
    <div class="form-row">
      <label for="route_name">Route name</label>
      <input id="route_name" name="route_name" type="text" placeholder="Optional (ex: Tulcea–Constanța)">
    </div>

    <div class="form-row">
      <label for="route_departure">Departure</label>
      <input id="route_departure" name="route_departure" type="text" placeholder="Port / location">
    </div>

    <div class="form-row">
      <label for="route_destination">Destination</label>
      <input id="route_destination" name="route_destination" type="text" placeholder="Port / location">
    </div>

    <div class="form-row">
      <label for="speed_kn">Speed (knots)</label>
      <input id="speed_kn" name="speed_kn" type="number" step="0.1" min="0" placeholder="ex: 9.5" required>
    </div>

    <div class="form-row">
      <label for="waypoints">Waypoints (lat, lon)</label>
      <textarea id="waypoints" name="waypoints" rows="6" placeholder="Example:
45.17, 28.79
44.16, 28.64
41.01, 28.97" required></textarea>
      <p class="small-hint">One point per line. Minimum 2 points. You can also separate with semicolons.</p>
    </div>

    <div class="form-row">
      <label for="route_notes">Notes</label>
      <textarea id="route_notes" name="route_notes" rows="3" placeholder="Traffic, shallow waters, restrictions..."></textarea>
    </div>

    <div class="form-row">
      <label>Pre-departure checklist</label>
      <div class="checklist-form">
        <label><input type="checkbox" name="fuel"> Fuel checked</label>
        <label><input type="checkbox" name="weather"> Weather checked</label>
        <label><input type="checkbox" name="crew"> Crew briefed</label>
        <label><input type="checkbox" name="documents"> Documents on board</label>
        <label><input type="checkbox" name="safety"> Safety briefing</label>
      </div>
    </div>

    <button type="submit" class="btn">Save route + calculate</button>
  </form>
</section>

{% if routes %}
<section class="ned-card">
  <h3>Saved routes</h3>                       
  <table class="voyage-table">
    <thead>
      <tr>
        <th>#</th>
        <th>Route</th>
        <th>Total (NM)</th>
        <th>ETA</th>
        <th>Segments</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for r in routes %}
      {% set route_index = loop.index0 %}

      <tr>
        <td>{{ loop.index }}</td>
        <td>
          <strong>{{ r.name }}</strong><br>
          <span class="small-hint">{{ r.departure }} → {{ r.destination }}</span>
          {% if r.author %}
            <br><span class="small-hint">by {{ r.author }}</span>
          {% endif %}
        </td>
        <td>{{ r.calc.total_nm if r.calc else "-" }}</td>
        <td>{{ r.calc.total_eta_hhmm if r.calc else "-" }}</td>
        <td>
          {% if r.calc and r.calc.segments %}
            {{ r.calc.segments|length }}
          {% else %}
            -
          {% endif %}
        </td>
        <td>
          <div class="route-actions">
             <a class="nav-link" href="{{ url_for('export_route_csv', index=route_index) }}">
               Export CSV
             </a>
             <a class="nav-link" href="{{ url_for('route_map', route_id=r.id) }}">Map</a>
             <a class="nav-link" href="{{ url_for('route_chat', route_id=r.id) }}">Route chat</a>
             <a class="nav-link" href="{{ url_for('export_route_geojson', index=route_index) }}">
               GeoJSON
             </a>
           </div>
        </td>

      </tr>

      {% if r.calc and r.calc.segments %}
      <tr>
        <td colspan="6">
          <div class="notes-section">
            <strong>Segments</strong>
            <table class="voyage-table" style="margin-top:8px;">
              <thead>
                <tr>
                  <th>#</th>
                  <th>From (lat,lon)</th>
                  <th>To (lat,lon)</th>
                  <th>NM</th>
                  <th>Bearing</th>
                  <th>ETA</th>
                </tr>
              </thead>
              <tbody>
                {% for s in r.calc.segments %}
                <tr>
                  <td>{{ loop.index }}</td>
                  <td>{{ s.from.lat }}, {{ s.from.lon }}</td>
                  <td>{{ s.to.lat }}, {{ s.to.lon }}</td>
                  <td>{{ s.distance_nm }}</td>
                  <td>{{ s.bearing_deg }}°</td>
                  <td>{{ s.eta_hhmm }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </td>
      </tr>
      {% endif %}

      {% endfor %}
    </tbody>
  </table>
</section>
{% endif %}
{% endblock %}


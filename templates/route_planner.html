{% extends "base.html" %}
{% block title %}Route Planner · NED{% endblock %}

{% block content %}
<section class="ned-card">
  <h2>Route Planner</h2>
  <p class="small-hint">Enter waypoints as coordinates or location names. NED will calculate distance, bearing and ETA.</p>

  {% if calc_error %}
    <p style="color:#b00020; font-size:0.9rem;">{{ calc_error }}</p>
  {% endif %}

  <form method="post" action="{{ url_for('route_planner') }}" class="voyage-form">
    <div class="form-row">
      <label for="route_name">Route name</label>
      <input id="route_name" name="route_name" type="text" placeholder="Optional (ex: Tulcea–Constanța)">
    </div>

    <div class="form-row">
      <label for="route_departure">Departure</label>
      <input id="route_departure" name="route_departure" type="text" placeholder="Port / location">
    </div>

    <div class="form-row">
      <label for="route_destination">Destination</label>
      <input id="route_destination" name="route_destination" type="text" placeholder="Port / location">
    </div>

    <div class="form-row">
      <label for="speed_kn">Speed (knots)</label>
      <input id="speed_kn" name="speed_kn" type="number" step="0.1" min="0" placeholder="ex: 9.5" required>
    </div>

    <div class="form-row">
      <label>Quick add location (local suggestions)</label>

      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <input
          id="locSearch"
          type="text"
          placeholder="Search location name..."
          list="locSuggestions"
          autocomplete="off"
          style="flex:1; min-width:220px;"
        >
        <button type="button" id="addLocBtn" class="btn">Add</button>
      </div>

      <small class="small-hint">
        Start typing a known location name (from your local locations.json), pick a suggestion, then press Add.
      </small>

      <datalist id="locSuggestions"></datalist>
    </div>

    <div class="form-row">
      <label for="waypoints">Waypoints (lat, lon) OR location name</label>
      <textarea id="waypoints" name="waypoints" rows="6" placeholder="Example:
45.17, 28.79
Braila
44.16, 28.64
Tulcea" required></textarea>

      <p class="small-hint">One point per line. Minimum 2 points. You can also separate with semicolons.</p>
    </div>

    <div class="form-row">
      <label for="route_notes">Notes</label>
      <textarea id="route_notes" name="route_notes" rows="3" placeholder="Traffic, shallow waters, restrictions..."></textarea>
    </div>

    <div class="form-row">
      <label>Pre-departure checklist</label>
      <div class="checklist-form">
        <label><input type="checkbox" name="fuel"> Fuel checked</label>
        <label><input type="checkbox" name="weather"> Weather checked</label>
        <label><input type="checkbox" name="crew"> Crew briefed</label>
        <label><input type="checkbox" name="documents"> Documents on board</label>
        <label><input type="checkbox" name="safety"> Safety briefing</label>
      </div>
    </div>

    <button type="submit" class="btn">Save route + calculate</button>
  </form>
</section>

{% if routes %}
<section class="ned-card">
  <h3>Saved routes</h3>
  <label style="margin:0;">
  Status
  <select name="status">
    <option value="planned" {{ 'selected' if request.args.get('status','planned')=='planned' else '' }}>Planned</option>
    <option value="done" {{ 'selected' if request.args.get('status')=='done' else '' }}>Done</option>
    <option value="all" {{ 'selected' if request.args.get('status')=='all' else '' }}>All</option>
  </select>
</label>

    <form method="get" action="{{ url_for('route_planner') }}" class="voyage-form" style="margin: 10px 0 14px 0;">
    <div class="form-row" style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
      <label style="margin:0;">
        Sort
        <select name="sort">
          <option value="new" {{ 'selected' if request.args.get('sort','new')=='new' else '' }}>Newest</option>
          <option value="old" {{ 'selected' if request.args.get('sort')=='old' else '' }}>Oldest</option>
          <option value="nm_desc" {{ 'selected' if request.args.get('sort')=='nm_desc' else '' }}>Distance ↓</option>
          <option value="nm_asc" {{ 'selected' if request.args.get('sort')=='nm_asc' else '' }}>Distance ↑</option>
        </select>
      </label>

      <label style="margin:0;">
        Show
        <select name="limit">
          <option value="10" {{ 'selected' if request.args.get('limit','10')=='10' else '' }}>10</option>
          <option value="25" {{ 'selected' if request.args.get('limit')=='25' else '' }}>25</option>
          <option value="50" {{ 'selected' if request.args.get('limit')=='50' else '' }}>50</option>
          <option value="all" {{ 'selected' if request.args.get('limit')=='all' else '' }}>All</option>
        </select>
      </label>

      <button type="submit" class="btn">Apply</button>
    </div>
  </form>

  <table class="voyage-table">
    <thead>
      <tr>
        <th>#</th>
        <th>Route</th>
        <th>Total (NM)</th>
        <th>ETA</th>
        <th>Segments</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for r in routes %}
      {% set route_index = loop.index0 %}

      <tr>
        <td>{{ loop.index }}</td>
        <td>
          <strong>{{ r.name }}</strong><br>
          <span class="small-hint">{{ r.departure }} → {{ r.destination }}</span>
          {% if r.author %}
            <br><span class="small-hint">by {{ r.author }}</span>
          {% endif %}
        </td>
        <td>{{ r.calc.total_nm if r.calc else "-" }}</td>
        <td>{{ r.calc.total_eta_hhmm if r.calc else "-" }}</td>
        <td>
          {% if r.calc and r.calc.segments %}
            {{ r.calc.segments|length }}
          {% else %}
            -
          {% endif %}
        </td>
        <td>
          <div class="route-actions">
                        <a class="nav-link" href="{{ url_for('export_route_csv', index=route_index) }}"> Export CSV </a>
            <a class="nav-link" href="{{ url_for('route_map', route_id=r.id) }}">Map</a>
            <a class="nav-link" href="{{ url_for('route_chat', route_id=r.id) }}">Route chat</a>
            <a class="nav-link" href="{{ url_for('export_route_geojson', index=route_index) }}"> GeoJSON </a>
            <button type="button" class="nav-link" onclick="toggleSeg('{{ r.id }}')">Segments</button>


          {# DELETE – doar admin sau owner #}
          {% set is_owner = r.author_id == session.get("user_id") %}

          {% if is_admin or is_owner %}
            <form method="post"
                  action="{{ url_for('delete_route', route_id=r.id) }}"
                  style="display:inline;"
                  onsubmit="return confirm('Delete this route? This action cannot be undone.');">
              <button type="submit" class="nav-link" style="color:#b00020;">
                Delete
              </button>
            </form>
          {% endif %}

          {% if is_admin or is_owner %}
            <form method="post"
                  action="{{ url_for('mark_route_done', route_id=r.id) }}"
                  style="display:inline;"
                  onsubmit="return confirm('Mark this route as DONE?');">
              <button type="submit" class="nav-link" style="color:#0b5;">
                Done
              </button>
            </form>
          {% endif %}


           </div>
        </td>
      </tr>

      {% if r.calc and r.calc.segments %}
        <tr id="seg-{{ r.id }}" style="display:none;">
          <td colspan="6">
          <div class="notes-section">
            <strong>Segments</strong>
            <table class="voyage-table" style="margin-top:8px;">
              <thead>
                <tr>
                  <th>#</th>
                  <th>From (lat,lon)</th>
                  <th>To (lat,lon)</th>
                  <th>NM</th>
                  <th>Bearing</th>
                  <th>ETA</th>
                </tr>
              </thead>
              <tbody>
                {% for s in r.calc.segments %}
                <tr>
                  <td>{{ loop.index }}</td>
                  <td>{{ s.from.lat }}, {{ s.from.lon }}</td>
                  <td>{{ s.to.lat }}, {{ s.to.lon }}</td>
                  <td>{{ s.distance_nm }}</td>
                  <td>{{ s.bearing_deg }}°</td>
                  <td>{{ s.eta_hhmm }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </td>
      </tr>
      {% endif %}

      {% endfor %}
    </tbody>
  </table>
</section>
{% endif %}

<script>
(function () {
  const locSearch = document.getElementById("locSearch");
  const datalist = document.getElementById("locSuggestions");
  const addBtn = document.getElementById("addLocBtn");
  const waypoints = document.querySelector('textarea[name="waypoints"]');

  if (!locSearch || !datalist || !addBtn || !waypoints) return;

  let timer = null;

  async function loadSuggestions(q) {
    const resp = await fetch(`/api/locations/suggest?q=${encodeURIComponent(q)}`);
    if (!resp.ok) return [];
    const data = await resp.json();
    return (data.results || []).slice(0, 10);
  }

  function setDatalist(items) {
    datalist.innerHTML = "";
    items.forEach(name => {
      const opt = document.createElement("option");
      opt.value = name;
      datalist.appendChild(opt);
    });
  }

  locSearch.addEventListener("input", () => {
    clearTimeout(timer);
    const q = locSearch.value.trim();
    if (!q) {
      setDatalist([]);
      return;
    }

    timer = setTimeout(async () => {
      const items = await loadSuggestions(q);
      setDatalist(items);
    }, 200);
  });

  addBtn.addEventListener("click", () => {
    const name = locSearch.value.trim();
    if (!name) return;
    waypoints.value = (waypoints.value ? waypoints.value + "\n" : "") + name;
    locSearch.value = "";
    setDatalist([]);
    waypoints.focus();
  });

  locSearch.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      addBtn.click();
    }
  });
})();
</script>

<script>
function toggleSeg(id) {
  const row = document.getElementById("seg-" + id);
  if (!row) return;
  row.style.display = (row.style.display === "none" || row.style.display === "") ? "table-row" : "none";
}
</script>


{% endblock %}

{% extends "base.html" %}

{% block title %}Voyage Sheet · NED{% endblock %}

{% block content %}
<section class="ned-card">
    <h2>Voyage Sheet</h2>
    <p>Fill in the basic details for your next voyage.</p>

    {% if is_authenticated %}
    <form method="post" action="{{ url_for('voyage_sheet') }}" class="voyage-form">
        <!-- Hidden field used when editing an existing voyage -->
        <input type="hidden" name="voyage_index" value="{{ edit_index if editing else '' }}">

        <div class="form-row">
            <label for="departure">Departure</label>
            <input
                type="text"
                id="departure"
                name="departure"
                placeholder="Departure port / location"
                value="{{ form_voyage.departure if form_voyage else '' }}"
                required
            >
        </div>

        <div class="form-row">
            <label for="destination">Destination</label>
            <input
                type="text"
                id="destination"
                name="destination"
                placeholder="Destination port / location"
                value="{{ form_voyage.destination if form_voyage else '' }}"
                required
            >
        </div>

        <div class="form-row">
            <label for="etd">ETD</label>
            <input
                type="datetime-local"
                id="etd"
                name="etd"
                value="{{ form_voyage.etd if form_voyage and form_voyage.etd else '' }}"
            >
        </div>

        <div class="form-row">
            <label for="eta">ETA</label>
            <input
                type="datetime-local"
                id="eta"
                name="eta"
                value="{{ form_voyage.eta if form_voyage and form_voyage.eta else '' }}"
            >
        </div>

        <div class="form-row">
            <label for="distance_nm">Estimated distance (NM)</label>
            <input
                type="number"
                id="distance_nm"
                name="distance_nm"
                step="0.1"
                min="0"
                value="{{ form_voyage.distance_nm if form_voyage and form_voyage.distance_nm else '' }}"
            >
        </div>

        <div class="form-row">
            <label for="notes">Notes</label>
            <textarea
                id="notes"
                name="notes"
                rows="3"
                placeholder="Observations, traffic, shallow areas, local tips..."
            >{{ form_voyage.notes if form_voyage and form_voyage.notes else '' }}</textarea>
        </div>

        <button type="submit" class="btn">
            {% if editing %}Update voyage{% else %}Save voyage{% endif %}
        </button>
    </form>
    {% else %}
        <p class="small-hint">
            This feature is available for logged-in users.
        </p>
    {% endif %}
</section>

{% if voyages %}
<section class="ned-card">
    <h3>Saved voyages</h3>
    <p>
        Quick overview of all voyages stored so far.
        {% if voyage_count is not none %}
            (Total: {{ voyage_count }})
        {% endif %}
    </p>

    <table class="voyage-table">
        <thead>
            <tr>
                <th>#</th>
                <th>Departure → Destination</th>
                <th>ETD / ETA</th>
                <th>Distance (NM)</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for v in voyages %}
            {% set is_owner = (current_user and (v.user_id == current_user.id or v.author_id == current_user.id)) %}
            <tr class="{% if is_owner %}own-voyage{% endif %}">
                <td>{{ loop.index }}</td>
                <td>
                    <strong>{{ v.departure }}</strong>
                    &rarr;
                    <strong>{{ v.destination }}</strong>
                </td>
                <td>
                    <div class="voyage-time">
                        <span>ETD: {{ v.etd or "-" }}</span><br>
                        <span>ETA: {{ v.eta or "-" }}</span>
                    </div>
                </td>
                <td>{{ v.distance_nm or "-" }}</td>
                <td>
                    <div class="voyage-actions">
                        <!-- See notes (read-only) -->
                        <form method="get" action="{{ url_for('voyage_sheet') }}">
                            <input type="hidden" name="view" value="{{ loop.index0 }}">
                            <button type="submit" class="btn btn-secondary btn-small">
                                See notes
                            </button>
                        </form>

                        {% if is_authenticated and (is_admin or is_owner) %}
                        <!-- Edit -->
                        <form method="get" action="{{ url_for('voyage_sheet') }}">
                            <input type="hidden" name="edit" value="{{ loop.index0 }}">
                            <button type="submit" class="btn btn-secondary btn-small">
                                Edit
                            </button>
                        </form>

                        <!-- Delete -->
                        <form method="post" action="{{ url_for('delete_voyage', index=loop.index0) }}"
                              onsubmit="return confirm('Delete this voyage? This action cannot be undone.');">
                            <button type="submit" class="btn btn-danger btn-small">
                                Delete
                            </button>
                        </form>
                        {% else %}
                            <span class="small-hint">Log in to manage.</span>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    {% if selected_voyage %}
    <div class="notes-section">
        <h4>Notes for voyage #{{ selected_index }}</h4>
        <p>
            <strong>{{ selected_voyage.departure }}</strong>
            &rarr;
            <strong>{{ selected_voyage.destination }}</strong>
        </p>

        {% if selected_voyage.notes %}
            <p class="voyage-notes-full">{{ selected_voyage.notes }}</p>
        {% else %}
            <p class="notes-empty">No notes for this voyage yet.</p>
        {% endif %}
    </div>
    {% endif %}
</section>
{% endif %}
{% endblock %}
